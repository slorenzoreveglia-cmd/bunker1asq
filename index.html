<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1ASQ - BUNKER</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d111a; --panel: #161b2b; --red: #e94560; --blue: #3498db; --border: #242c42; --gray: #8b949e; }
        body { background: var(--bg); color: white; font-family: 'Roboto Mono', monospace; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        /* LOGIN REPLICATO */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; }
        .iasq-logo { font-family: 'Creepster', cursive; font-size: 100px; color: #d1d1d1; text-shadow: 0 0 25px var(--red); margin-bottom: 20px; }
        .login-card { background: var(--panel); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); width: 340px; border: 1px solid var(--border); text-align: center; }
        
        select, input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #0d1117; border: 1px solid var(--border); color: white; border-radius: 8px; font-family: 'Roboto Mono', monospace; box-sizing: border-box; }
        .btn-main { background: var(--red); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-main:hover { background: #ff2e63; }

        /* BUNKER SCREEN */
        #bunker-screen { display: none; width: 100%; padding: 20px; max-width: 1100px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .skull-notif { background: rgba(233, 69, 96, 0.15); border: 1.5px solid var(--red); padding: 8px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .alunno-title { font-family: 'Creepster', cursive; font-size: 32px; color: var(--red); margin: 15px 0; }

        /* CALENDARIO IDENTICO A calendario_bello.png */
        .calendar-wrap { background: var(--panel); border-radius: 15px; border: 1px solid var(--border); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { color: var(--gray); padding: 10px; font-size: 13px; text-transform: lowercase; font-weight: normal; }
        td { height: 110px; border: 0.5px solid var(--border); vertical-align: top; padding: 5px; cursor: pointer; position: relative; }
        td.past { background: rgba(0,0,0,0.2); cursor: default; }
        td.today { border: 1.5px solid var(--red); background: rgba(233, 69, 96, 0.05); }
        .day-label { float: right; font-size: 12px; color: var(--gray); margin: 3px; }

        .event-tag { font-size: 9px; padding: 3px 6px; border-radius: 4px; margin-top: 5px; font-weight: bold; display: block; overflow: hidden; text-overflow: ellipsis; }
        .tag-interrogazione { background: var(--red); color: white; }
        .tag-verifica { background: var(--blue); color: white; }
        .tag-altro { background: #f1c40f; color: black; }

        /* MODALI BELLI */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 999; }
        .modal-box { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 2px solid var(--red); width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; z-index: 1000; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="iasq-logo">IASQ</div>
        <div class="login-card">
            <select id="user-select"><option>CARICAMENTO DATABASE...</option></select>
            <input type="password" id="pin-input" placeholder="PIN DI ACCESSO">
            <button class="btn-main" onclick="tryLogin()">ENTRA NEL BUNKER</button>
        </div>
    </div>

    <div id="bunker-screen">
        <div class="header-top">
            <button onclick="location.reload()" style="background:none; border:none; color:white; cursor:pointer; font-family:'Roboto Mono'">‚Üê ESCI</button>
            <div class="skull-notif" onclick="openDestini()">üíÄ <span id="skull-count">0</span> +</div>
            <div style="font-size:10px; color:var(--gray)">SISTEMA OPERATIVO</div>
        </div>
        <div class="alunno-title">ALUNNO: <span id="current-name"></span></div>
        <div class="calendar-wrap">
            <div class="month-header">
                <div id="month-display" style="font-size: 24px; font-weight: bold; text-transform: lowercase;"></div>
                <div>
                    <button onclick="moveMonth(-1)" style="background:none; border:none; color:white; cursor:pointer; font-size:25px;"> < </button>
                    <button onclick="moveMonth(1)" style="background:none; border:none; color:white; cursor:pointer; font-size:25px;"> > </button>
                </div>
            </div>
            <table>
                <thead><tr><th>lun</th><th>mar</th><th>mer</th><th>gio</th><th>ven</th><th>sab</th><th>dom</th></tr></thead>
                <tbody id="calendar-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay" onclick="closeAll()"></div>
    <div id="modal-add" class="modal-box">
        <h2 style="font-family:'Creepster'; color:var(--red); margin:0; font-size:30px;">PIANIFICA DESTINO</h2>
        <p id="sel-date-txt" style="font-size:11px; color:var(--gray); margin-bottom:15px;"></p>
        
        <label style="font-size:10px; color:var(--gray)">TIPO</label>
        <select id="in-tipo" onchange="toggleTipo()">
            <option value="interrogazione">Interrogazione üìù</option>
            <option value="verifica">Verifica üìö</option>
        </select>
        
        <label style="font-size:10px; color:var(--gray)">MATERIA</label>
        <select id="in-materia" onchange="document.getElementById('in-altro').style.display=(this.value=='Altro'?'block':'none')">
            <option value="Matematica">Matematica</option><option value="Fisica">Fisica</option><option value="Inglese">Inglese</option><option value="Diritto">Diritto</option><option value="TTRG">TTRG</option><option value="Scienze">Scienze</option><option value="Storia">Storia</option><option value="Altro">-- ALTRO --</option>
        </select>
        <input type="text" id="in-altro" placeholder="Scrivi materia..." style="display:none;">

        <div id="box-alunni">
            <label style="font-size:10px; color:var(--gray)">BERSAGLI</label>
            <div style="display:flex; gap:5px;">
                <select id="sel-alunno-list" style="flex:2;"><option value="">Aggiungi...</option></select>
                <input type="number" id="rand-n" placeholder="N¬∞" style="flex:1;">
                <button onclick="estrai()" style="background:var(--blue); border:none; color:white; border-radius:8px; padding:0 15px; cursor:pointer;">üé≤</button>
            </div>
        </div>
        <textarea id="in-final" placeholder="Chi capita capita..." rows="2"></textarea>
        <textarea id="in-desc" placeholder="Descrizione (opzionale)" rows="2"></textarea>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-main" id="btn-save" onclick="salva()">CONFERMA</button>
            <button class="btn-main" style="background:#242c42;" onclick="closeAll()">ANNULLA</button>
        </div>
    </div>

    <div id="modal-list" class="modal-box">
        <h2 style="font-family:'Creepster'; color:var(--red); font-size:30px;">I TUOI DESTINI</h2>
        <div id="destini-content" style="max-height:350px; overflow-y:auto; padding-right:5px;"></div>
        <button class="btn-main" style="background:#242c42; margin-top:20px;" onclick="closeAll()">CHIUDI</button>
    </div>

    <script>
        // *** METTI IL TUO URL QUI ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxBD-5Cc2nVUPTTdM2if2jRvNfezWklU1uCFOENzPWDyVMKL1_BfRUMqzqfwokgQ8gyQ/exec";
        
        let db = { events: [], pins: {} };
        let curM = new Date();
        let selD = "";
        let isLogged = false;

        // CARICAMENTO INIZIALE
        async function sync() {
            try {
                const r = await fetch(`${SCRIPT_URL}?action=getInitialData`);
                db = await r.json();
                const s1 = document.getElementById('user-select');
                const s2 = document.getElementById('sel-alunno-list');
                const names = Object.keys(db.pins).sort();
                s1.innerHTML = '<option value="">Seleziona Soldato</option>';
                s2.innerHTML = '<option value="">Aggiungi Alunno</option>';
                names.forEach(n => {
                    s1.innerHTML += `<option value="${n}">${n}</option>`;
                    s2.innerHTML += `<option value="${n}">${n}</option>`;
                });
                if(isLogged) render();
            } catch(e) { console.error("Errore sincronizzazione iniziale"); }
        }

        window.onload = sync;

        function tryLogin() {
            const u = document.getElementById('user-select').value;
            const p = document.getElementById('pin-input').value;
            if (db.pins[u] && db.pins[u] === p) {
                isLogged = true;
                document.getElementById('login-screen').style.display='none';
                document.getElementById('bunker-screen').style.display='block';
                document.getElementById('current-name').innerText = u.toUpperCase();
                render();
            } else { alert("ACCESSO NEGATO: PIN ERRATO"); }
        }

        function render() {
            const body = document.getElementById('calendar-body');
            body.innerHTML = '';
            const y = curM.getFullYear(), m = curM.getMonth();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('month-display').innerText = new Intl.DateTimeFormat('it-IT',{month:'long',year:'numeric'}).format(curM);
            
            let first = new Date(y, m, 1).getDay();
            first = first === 0 ? 6 : first - 1;
            const days = new Date(y, m + 1, 0).getDate();

            let d = 1;
            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    let cell = document.createElement('td');
                    if (i === 0 && j < first) {
                        cell.classList.add('past');
                    } else if (d <= days) {
                        const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        cell.innerHTML = `<span class="day-label">${d}</span>`;
                        if (dStr < today) cell.classList.add('past');
                        if (dStr === today) cell.classList.add('today');
                        
                        db.events.filter(e => e.data && e.data.startsWith(dStr)).forEach(e => {
                            const c = e.materia_special ? 'tag-altro' : `tag-${e.tipo}`;
                            cell.innerHTML += `<div class="event-tag ${c}">${e.materia.toUpperCase()}</div>`;
                        });

                        if (dStr >= today) cell.onclick = (e) => { selD = dStr; openAdd(); };
                        d++;
                    }
                    row.appendChild(cell);
                }
                body.appendChild(row);
                if (d > days) break;
            }
            document.getElementById('skull-count').innerText = db.events.length;
        }

        function openAdd() { 
            document.getElementById('sel-date-txt').innerText = "OPERAZIONE DEL: " + selD;
            document.getElementById('modal-add').style.display='block';
            document.getElementById('modal-overlay').style.display='block';
        }

        function toggleTipo() {
            const isV = document.getElementById('in-tipo').value === 'verifica';
            document.getElementById('box-alunni').style.display = isV ? 'none' : 'block';
            document.getElementById('in-final').value = isV ? "TUTTA LA CLASSE" : "";
        }

        document.getElementById('sel-alunno-list').onchange = function() {
            const f = document.getElementById('in-final');
            f.value = f.value ? f.value + ", " + this.value : this.value;
        };

        function estrai() {
            const n = parseInt(document.getElementById('rand-n').value);
            const names = Object.keys(db.pins);
            if(!n || n < 1) return;
            let res = [];
            while(res.length < n && res.length < names.length) {
                let r = names[Math.floor(Math.random()*names.length)];
                if(!res.includes(r)) res.push(r);
            }
            document.getElementById('in-final').value = res.join(', ');
        }

        // SALVATAGGIO ANTI-LOGOUT (USA FETCH SILENZIOSA)
        async function salva() {
            const btn = document.getElementById('btn-save');
            btn.innerText = "SINCRO IN CORSO..."; btn.disabled = true;

            let mat = document.getElementById('in-materia').value;
            let sp = false;
            if(mat === 'Altro') { mat = document.getElementById('in-altro').value || 'Altro'; sp = true; }

            const payload = {
                action: 'saveEvent',
                event: {
                    id: Date.now(),
                    data: selD,
                    tipo: document.getElementById('in-tipo').value,
                    materia: mat,
                    alunno: document.getElementById('in-final').value,
                    desc: document.getElementById('in-desc').value,
                    materia_special: sp
                }
            };

            // TRUCCO: Invio dati senza aspettare la risposta CORS che blocca tutto
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            }).then(() => {
                // Chiudiamo e resettiamo senza ricaricare la pagina
                setTimeout(() => {
                    closeAll();
                    btn.innerText = "CONFERMA"; btn.disabled = false;
                    sync(); // Ricarica i dati dal database in background
                }, 1000);
            }).catch(err => {
                alert("Errore di rete, ma i dati potrebbero essere stati inviati.");
                btn.disabled = false;
            });
        }

        function openDestini() {
            const c = document.getElementById('destini-content'); c.innerHTML = '';
            const future = db.events.filter(e => e.data >= new Date().toISOString().split('T')[0]).sort((a,b)=>a.data.localeCompare(b.data));
            if(future.length === 0) c.innerHTML = "<p style='color:var(--gray)'>Nessun destino imminente...</p>";
            future.forEach(e => {
                c.innerHTML += `
                <div style="background:#1e253a; border-left:4px solid var(--red); padding:12px; margin-bottom:12px; border-radius:10px;">
                    <b style="color:var(--red); font-size:16px;">${e.materia.toUpperCase()}</b><br>
                    <div style="font-size:12px; margin-top:5px;">üë§ ${e.alunno}</div>
                    <div style="font-size:11px; color:var(--gray); margin-top:3px;">üìÖ ${e.data} (${e.tipo})</div>
                    ${e.desc ? `<div style="font-size:11px; color:#fff; margin-top:8px; border-top:1px solid #333; padding-top:5px;">${e.desc}</div>` : ''}
                </div>`;
            });
            document.getElementById('modal-list').style.display='block';
            document.getElementById('modal-overlay').style.display='block';
        }

        function closeAll() {
            document.getElementById('modal-add').style.display='none';
            document.getElementById('modal-list').style.display='none';
            document.getElementById('modal-overlay').style.display='none';
        }

        function moveMonth(v) { curM.setMonth(curM.getMonth()+v); render(); }
    </script>
</body>
</html>
