<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1ASQ - Bunker Clandestino</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Nosifer&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --accent-red: #8b0000;
            --text-color: #e0e0e0;
            --verify-bg: #1a2a3a;
            --other-bg: #4a3c00;
        }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Roboto', sans-serif; margin: 0; padding: 10px; }
        
        /* LOGIN SCREEN */
        #login-screen { text-align: center; padding-top: 50px; }
        .login-box { background: #111; border: 2px solid var(--accent-red); padding: 20px; display: inline-block; width: 90%; max-width: 350px; }

        /* CALENDARIO RESPONSIVE */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; max-width: 1000px; margin: 0 auto; }
        .day { background: #1a1a1a; border: 1px solid #333; min-height: 90px; padding: 5px; font-size: 0.7rem; position: relative; }
        .day.past { background: #0a0a0a; color: #444; border-color: #222; }
        .day.today { border: 2px solid var(--accent-red); box-shadow: inset 0 0 10px #f00; }

        /* EVENTI */
        .event { margin-top: 3px; padding: 3px; border-radius: 3px; font-size: 0.65rem; border-left: 3px solid var(--accent-red); background: #220000; cursor: pointer; }
        .event.verifica { border-left-color: #3498db; background: var(--verify-bg); }
        .event.altro { border-left-color: #d4af37; background: var(--other-bg); }

        /* NOTIFICHE */
        #notif-trigger { position: fixed; top: 15px; right: 15px; background: #000; border: 1px solid var(--accent-red); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; }
        #notif-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }

        /* MODALI */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; border: 2px solid var(--accent-red); padding: 20px; z-index: 500; width: 85%; max-width: 400px; box-shadow: 0 0 50px #000; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 400; }

        input, select, button { width: 100%; padding: 12px; margin: 8px 0; background: #222; color: #fff; border: 1px solid #444; border-radius: 5px; box-sizing: border-box; }
        .btn-action { background: var(--accent-red); font-family: 'Creepster', cursive; font-size: 1.2rem; cursor: pointer; border: none; }
        
        h1 { font-family: 'Nosifer', cursive; color: var(--accent-red); font-size: 1.4rem; text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>BUNKER LOGIN</h1>
        <div class="login-box">
            <input type="text" id="login-name" placeholder="Nome Cognome (es: Lorenzo Reveglia)">
            <input type="password" id="login-pin" placeholder="PIN (es: 018)">
            <button class="btn-action" onclick="attemptLogin()">ENTRA</button>
            <p id="login-err" style="color:red; display:none;">Accesso negato, soldato.</p>
        </div>
    </div>

    <div id="bunker-screen" style="display:none;">
        <div id="notif-trigger" onclick="showNotif()">
            üíÄ <span id="notif-badge">0</span>
        </div>

        <h1>1ASQ BUNKER</h1>
        <p style="text-align:center; font-size:0.8rem;">
            <span id="user-tag"></span> | <a href="#" onclick="logout()" style="color:var(--accent-red)">CAMBIA ACCOUNT</a>
        </p>

        <div id="calendar" class="calendar-grid"></div>
    </div>

    <div id="modal-choice" class="modal">
        <h3 id="date-label"></h3>
        <button onclick="openForm('interrogazione')">INTERROGAZIONE üìù</button>
        <button onclick="openForm('verifica')">VERIFICA üìö</button>
        <button onclick="closeModals()">ANNULLA</button>
    </div>

    <div id="modal-form" class="modal">
        <h2 id="form-type">INFO</h2>
        <select id="f-materia" onchange="toggleOther(this.value)">
            <option value="Italiano">Italiano</option>
            <option value="Matematica">Matematica</option>
            <option value="Inglese">Inglese</option>
            <option value="TTRG">TTRG</option>
            <option value="Diritto">Diritto</option>
            <option value="Scienze">Scienze</option>
            <option value="Altro">-- ALTRO --</option>
        </select>
        <input type="text" id="f-altro" placeholder="Nome materia..." style="display:none;">
        
        <div id="box-alunno">
            <select id="f-alunno"></select>
            <button onclick="pickRandom()">CASUALE üé≤</button>
        </div>

        <input type="text" id="f-desc" placeholder="Note (es: capitolo 4)">
        <button class="btn-action" id="btn-save" onclick="sendData()">CONFERMA</button>
        <button onclick="closeModals()">CHIUDI</button>
    </div>

    <div id="overlay" class="overlay" onclick="closeModals()"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxBD-5Cc2nVUPTTdM2if2jRvNfezWklU1uCFOENzPWDyVMKL1_BfRUMqzqfwokgQ8gyQ/exec";
        let db = { events: [], pins: {}, blacklist: [] };
        let selectedDate = null;
        let activeType = '';

        // Caricamento Iniziale
        window.onload = async () => {
            const savedUser = localStorage.getItem('bunker_user');
            if (savedUser) {
                await loadBunker(savedUser);
            }
        };

        async function attemptLogin() {
            const name = document.getElementById('login-name').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            
            // Scarichiamo i dati per controllare il PIN
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:'getInitialData'}) });
            db = await res.json();

            if (db.pins[name] === pin) {
                localStorage.setItem('bunker_user', name);
                loadBunker(name);
            } else {
                document.getElementById('login-err').style.display = 'block';
            }
        }

        async function loadBunker(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('bunker-screen').style.display = 'block';
            document.getElementById('user-tag').innerText = "SOLDATO: " + user;
            
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:'getInitialData'}) });
            db = await res.json();
            
            renderCalendar();
            updateNotifBadge();
        }

        function renderCalendar() {
            const container = document.getElementById('calendar');
            container.innerHTML = '';
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // Mostriamo 35 giorni a partire da luned√¨ scorso
            let current = new Date(today);
            current.setDate(today.getDate() - today.getDay() + 1);

            for (let i = 0; i < 35; i++) {
                const d = new Date(current);
                const isPast = d < today;
                const dStr = d.toISOString().split('T')[0];

                const div = document.createElement('div');
                div.className = `day ${isPast ? 'past' : ''} ${d.getTime() === today.getTime() ? 'today' : ''}`;
                div.innerHTML = `<b>${d.getDate()}</b><br><small>${d.toLocaleString('it-IT',{month:'short'})}</small>`;

                // Mostra Eventi
                db.events.filter(e => e.data.startsWith(dStr)).forEach(e => {
                    const evDiv = document.createElement('div');
                    evDiv.className = `event ${e.tipo} ${e.materia_special ? 'altro' : ''}`;
                    evDiv.innerText = `${e.tipo === 'verifica' ? 'üìö' : 'üìù'} ${e.materia}: ${e.alunno}`;
                    div.appendChild(evDiv);
                });

                if (!isPast) div.onclick = () => openChoice(dStr);
                container.appendChild(div);
                current.setDate(current.getDate() + 1);
            }
        }

        function openChoice(date) {
            selectedDate = date;
            document.getElementById('date-label').innerText = "DATA: " + date;
            document.getElementById('modal-choice').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function openForm(type) {
            activeType = type;
            document.getElementById('modal-choice').style.display = 'none';
            document.getElementById('modal-form').style.display = 'block';
            document.getElementById('form-type').innerText = type.toUpperCase();
            
            const boxAlunno = document.getElementById('box-alunno');
            if (type === 'verifica') {
                boxAlunno.style.display = 'none';
            } else {
                boxAlunno.style.display = 'block';
                const sel = document.getElementById('f-alunno');
                sel.innerHTML = '';
                Object.keys(db.pins).forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p; opt.innerText = p;
                    sel.appendChild(opt);
                });
            }
        }

        async function sendData() {
            const btn = document.getElementById('btn-save');
            btn.innerText = "INVIO IN CORSO...";
            btn.disabled = true;

            let materia = document.getElementById('f-materia').value;
            let isSpecial = false;
            if (materia === 'Altro') {
                materia = document.getElementById('f-altro').value;
                isSpecial = true;
            }

            const payload = {
                action: 'saveEvent',
                event: {
                    id: Date.now(),
                    data: selectedDate,
                    materia: materia,
                    tipo: activeType,
                    alunno: activeType === 'verifica' ? "TUTTA LA CLASSE" : document.getElementById('f-alunno').value,
                    desc: document.getElementById('f-desc').value,
                    materia_special: isSpecial
                }
            };

            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            location.reload();
        }

        function toggleOther(v) { document.getElementById('f-altro').style.display = (v === 'Altro') ? 'block' : 'none'; }
        
        function pickRandom() {
            const sel = document.getElementById('f-alunno');
            sel.selectedIndex = Math.floor(Math.random() * sel.options.length);
        }

        function updateNotifBadge() {
            const future = db.events.filter(e => new Date(e.data) >= new Date().setHours(0,0,0,0)).length;
            document.getElementById('notif-badge').innerText = future;
        }

        function showNotif() {
            const list = db.events.filter(e => new Date(e.data) >= new Date().setHours(0,0,0,0))
                        .map(e => `${e.data}: ${e.materia} (${e.alunno})`).join('\n');
            alert("PROSSIMI ALLERTA:\n" + (list || "Nessuno per ora. Riposati."));
        }

        function closeModals() { document.querySelectorAll('.modal, .overlay').forEach(e => e.style.display = 'none'); }
        
        function logout() { localStorage.removeItem('bunker_user'); location.reload(); }
    </script>
</body>
</html>
