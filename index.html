<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1ASQ - BUNKER</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --accent: #e94560;
            --text: #c9d1d9;
        }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- LOGIN --- */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; }
        .logo { font-family: 'Creepster', cursive; font-size: 70px; color: white; text-shadow: 0 0 15px var(--accent); margin-bottom: 20px; }
        .login-card { background: var(--card); padding: 30px; border-radius: 12px; width: 300px; border: 1px solid #30363d; }

        /* --- HEADER --- */
        #bunker-screen { width: 100%; max-width: 900px; padding: 20px; display: none; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .skull { cursor: pointer; border: 1px solid var(--accent); padding: 5px 15px; border-radius: 20px; background: rgba(233, 69, 96, 0.1); }

        /* --- CALENDARIO --- */
        .cal-box { background: var(--card); border-radius: 10px; padding: 15px; border: 1px solid #30363d; }
        .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { color: var(--text); padding: 10px; font-size: 0.8rem; text-transform: uppercase; }
        td { height: 90px; width: 14%; border: 1px solid #30363d; vertical-align: top; padding: 5px; cursor: pointer; position: relative; }
        td:hover { background: #21262d; }
        td.past { background: #0d1117; color: #484f58; cursor: default; }
        
        .day-n { float: right; font-size: 12px; color: var(--text); }
        .ev-tag { background: var(--accent); font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-top: 18px; font-weight: bold; overflow: hidden; }
        .ev-ver { background: #3498db; }

        /* --- MODALI --- */
        .modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: var(--card); border: 2px solid var(--accent); padding: 20px; 
            border-radius: 10px; z-index: 100; width: 85%; max-width: 350px; 
        }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; }
        
        input, select, button { width: 100%; padding: 10px; margin: 8px 0; border-radius: 5px; border: 1px solid #30363d; background: #0d1117; color: white; }
        .btn-red { background: var(--accent); border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="logo">1ASQ</div>
        <div class="login-card">
            <select id="user-list"><option>Caricamento...</option></select>
            <input type="password" id="user-pin" placeholder="PIN">
            <button class="btn-red" onclick="doLogin()">ENTRA</button>
        </div>
    </div>

    <div id="bunker-screen">
        <div class="top-bar">
            <button onclick="location.reload()" style="width:auto; padding:5px 10px;">ESCI</button>
            <div class="skull" onclick="showNotif()">üíÄ <span id="n-val">0</span> +</div>
            <div style="font-family:'Creepster'; color:var(--accent); font-size:20px;">SOLDATO: <span id="u-name"></span></div>
        </div>

        <div class="cal-box">
            <div class="cal-nav">
                <button onclick="moveMonth(-1)" style="width:auto;">&lt;</button>
                <h3 id="m-name" style="text-transform: capitalize;"></h3>
                <button onclick="moveMonth(1)" style="width:auto;">&gt;</button>
            </div>
            <table>
                <thead><tr><th>lun</th><th>mar</th><th>mer</th><th>gio</th><th>ven</th><th>sab</th><th>dom</th></tr></thead>
                <tbody id="cal-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-add" class="modal">
        <h3 id="add-date" style="margin:0; color:var(--accent);"></h3>
        <select id="in-tipo"><option value="interrogazione">Interrogazione üìù</option><option value="verifica">Verifica üìö</option></select>
        <select id="in-mat">
            <option value="Italiano">Italiano</option><option value="Matematica">Matematica</option>
            <option value="Inglese">Inglese</option><option value="TTRG">TTRG</option>
            <option value="Diritto">Diritto</option><option value="Altro">-- ALTRO --</option>
        </select>
        <input type="text" id="in-altro" placeholder="Nome materia..." style="display:none;">
        <select id="in-alunno"></select>
        <input type="text" id="in-desc" placeholder="Descrizione">
        <button class="btn-red" id="btn-save" onclick="save()">SALVA</button>
        <button onclick="closeAll()">ANNULLA</button>
    </div>

    <div id="overlay" class="overlay" onclick="closeAll()"></div>

    <script>
        const SCRIPT_URL = "INSERISCI_QUI_IL_TUO_URL_EXEC";
        let db = { events: [], pins: {} };
        let vDate = new Date();
        let selD = "";

        window.onload = async () => {
            const r = await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'getInitialData'})});
            db = await r.json();
            const s = document.getElementById('user-list');
            s.innerHTML = "";
            Object.keys(db.pins).sort().forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`);
        };

        function doLogin() {
            const u = document.getElementById('user-list').value;
            const p = document.getElementById('user-pin').value;
            if (db.pins[u] === p) {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('bunker-screen').style.display='block';
                document.getElementById('u-name').innerText = u.toUpperCase();
                render();
            } else { alert("PIN ERRATO!"); }
        }

        function render() {
            const b = document.getElementById('cal-body'); b.innerHTML = "";
            const y = vDate.getFullYear(), m = vDate.getMonth();
            document.getElementById('m-name').innerText = new Intl.DateTimeFormat('it-IT',{month:'long',year:'numeric'}).format(vDate);
            
            let first = new Date(y, m, 1).getDay();
            first = first === 0 ? 6 : first - 1;
            const days = new Date(y, m + 1, 0).getDate();

            let d = 1;
            for (let i = 0; i < 6; i++) {
                let r = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    let c = document.createElement('td');
                    if (i === 0 && j < first) { c.style.border="none"; }
                    else if (d <= days) {
                        const cur = new Date(y,m,d);
                        const dStr = cur.toLocaleDateString('en-CA'); // YYYY-MM-DD sicuro
                        c.innerHTML = `<span class="day-n">${d}</span>`;
                        if (cur < new Date().setHours(0,0,0,0)) c.className = "past";
                        
                        db.events.filter(e => e.data === dStr).forEach(e => {
                            c.innerHTML += `<div class="ev-tag ${e.tipo==='verifica'?'ev-ver':''}">${e.materia.toUpperCase()}</div>`;
                        });

                        if (cur >= new Date().setHours(0,0,0,0)) c.onclick = () => openAdd(dStr);
                        d++;
                    }
                    r.appendChild(c);
                }
                b.appendChild(r);
                if (d > days) break;
            }
            document.getElementById('n-val').innerText = db.events.length;
        }

        function openAdd(date) {
            selD = date;
            document.getElementById('add-date').innerText = date;
            const s = document.getElementById('in-alunno');
            s.innerHTML = '<option value="TUTTA LA CLASSE">TUTTA LA CLASSE</option>';
            Object.keys(db.pins).sort().forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`);
            document.getElementById('modal-add').style.display='block';
            document.getElementById('overlay').style.display='block';
        }

        async function save() {
            const btn = document.getElementById('btn-save');
            btn.innerText = "INVIO..."; btn.disabled = true;
            
            let mat = document.getElementById('in-mat').value;
            if (mat === 'Altro') mat = document.getElementById('in-altro').value;

            const data = {
                action: 'saveEvent',
                event: {
                    id: Date.now(),
                    data: selD,
                    materia: mat,
                    tipo: document.getElementById('in-tipo').value,
                    alunno: document.getElementById('in-alunno').value,
                    desc: document.getElementById('in-desc').value
                }
            };

            await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify(data)});
            location.reload();
        }

        function moveMonth(v) { vDate.setMonth(vDate.getMonth()+v); render(); }
        function closeAll() { document.querySelectorAll('.modal, .overlay').forEach(e => e.style.display='none'); }
        function showNotif() { alert("Controlla il calendario per i dettagli delle interrogazioni!"); }
        document.getElementById('in-mat').onchange = function() { document.getElementById('in-altro').style.display = this.value==='Altro'?'block':'none'; };
    </script>
</body>
</html>
